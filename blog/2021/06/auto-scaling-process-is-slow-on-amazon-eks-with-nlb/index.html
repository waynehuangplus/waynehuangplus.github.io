<!doctype html><html lang=en><head><meta charset=utf-8><title>Auto-scaling process is slow on Amazon EKS with NLB - The Jorney of Wayne</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon sizes=180x180 href="/favicon/apple-touch-icon.png?v=1"><link rel=icon type=image/png sizes=32x32 href="/favicon/favicon-32x32.png?v=1"><link rel=icon type=image/png sizes=16x16 href="/favicon/favicon-16x16.png?v=1"><link rel=manifest href="/favicon/site.webmanifest?v=1"><link rel=mask-icon href="/favicon/safari-pinned-tab.svg?v=1" color=#ffffff><link rel="shortcut icon" href="/favicon/favicon.ico?v=1"><meta name=msapplication-config content="/favicon/browserconfig.xml?v=1"><meta name=msapplication-TileColor content="#ffffff"><meta name=theme-color content="#ffffff"><meta name=generator content="Hugo 0.83.1"><meta property="og:site_name" content="The Jorney of Wayne"><meta property="og:title" content="Auto-scaling process is slow on Amazon EKS with NLB"><meta property="og:description" content="Register target with target group is slow than expected behind the Network Load Balancer"><meta property="description" content="Register target with target group is slow than expected behind the Network Load Balancer"><meta property="og:url" content="https://blog.wayne.wiki/blog/2021/06/auto-scaling-process-is-slow-on-amazon-eks-with-nlb/"><meta property="og:type" content="article"><meta property="og:image" content="https://blog.wayne.wiki/img/post/2021-06-07-joshua-hoehne-7uN0bC2sNYE-unsplash.jpg"><meta property="og:image:alt" content="slow-by-joshua-hoehne"><link rel=stylesheet href=/css/bundle.min.6ad9eb85bff384c75937a02036b01425a2ca63f19a96535b8ba5b181db62a4b3.css integrity="sha256-atnrhb/zhMdZN6AgNrAUJaLKY/GallNbi6WxgdtipLM="><link rel=stylesheet href=/css/add-on.css></head><body><header id=site-header><nav id=site-nav><h1 class=nav-title><a href=/ class=nav>Blog</a></h1><menu id=site-nav-menu class="flyout-menu menu"><a href=/ class="nav link"><i class="fa fa-home"></i> Home</a>
<a href=/about class="nav link"><i class="far fa-id-card"></i> About</a>
<a href=/blog class="nav link"><i class="far fa-newspaper"></i> Blog</a>
<a href=/categories class="nav link"><i class="fas fa-sitemap"></i> Categories</a>
<a href=/contact class="nav link"><i class="far fa-envelope"></i> Contact</a>
<a href=#share-menu class="nav link share-toggle"><i class="fas fa-share-alt">&nbsp;</i>Share</a>
<a href=#search-input class="nav link search-toggle"><i class="fas fa-search">&nbsp;</i>Search</a></menu>
<a href=#search-input class="nav search-toggle"><i class="fas fa-search fa-2x">&nbsp;</i></a>
<a href=#share-menu class="nav share-toggle"><i class="fas fa-share-alt fa-2x">&nbsp;</i></a>
<a href=#site-nav class="nav nav-toggle"><i class="fas fa-bars fa-2x"></i></a></nav><menu id=search class=menu><input id=search-input class="search-input menu"></input><div id=search-results class="search-results menu"></div></menu><menu id=share-menu class="flyout-menu menu"><h1>Share Post</h1><a href="//twitter.com/share?text=Auto-scaling%20process%20is%20slow%20on%20Amazon%20EKS%20with%20NLB&url=https%3a%2f%2fblog.wayne.wiki%2fblog%2f2021%2f06%2fauto-scaling-process-is-slow-on-amazon-eks-with-nlb%2f" target=_blank rel=noopener class="nav share-btn twitter"><p>Twitter</p></a><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.wayne.wiki%2fblog%2f2021%2f06%2fauto-scaling-process-is-slow-on-amazon-eks-with-nlb%2f" target=_blank rel=noopener class="nav share-btn facebook"><p>Facebook</p></a><a href="//www.reddit.com/submit?url=https%3a%2f%2fblog.wayne.wiki%2fblog%2f2021%2f06%2fauto-scaling-process-is-slow-on-amazon-eks-with-nlb%2f&title=Auto-scaling%20process%20is%20slow%20on%20Amazon%20EKS%20with%20NLB" target=_blank rel=noopener class="nav share-btn reddit"><p>Reddit</p></a><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fblog.wayne.wiki%2fblog%2f2021%2f06%2fauto-scaling-process-is-slow-on-amazon-eks-with-nlb%2f&title=Auto-scaling%20process%20is%20slow%20on%20Amazon%20EKS%20with%20NLB" target=_blank rel=noopener class="nav share-btn linkedin"><p>LinkedIn</p></a><a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fblog.wayne.wiki%2fblog%2f2021%2f06%2fauto-scaling-process-is-slow-on-amazon-eks-with-nlb%2f&description=Auto-scaling%20process%20is%20slow%20on%20Amazon%20EKS%20with%20NLB" target=_blank rel=noopener class="nav share-btn pinterest"><p>Pinterest</p></a><a href="mailto:?subject=Check%20out%20this%20post%20by %7b%20%20%20%20%20%20%20%20map%5b%5d%7d&body=https%3a%2f%2fblog.wayne.wiki%2fblog%2f2021%2f06%2fauto-scaling-process-is-slow-on-amazon-eks-with-nlb%2f" target=_blank class="nav share-btn email" data-proofer-ignore><p>Email</p></a></menu></header><div id=wrapper><section id=site-intro><a href=/><img src=https://blog.wayne.wiki/img/main/wayne.JPG class=circle width=100 alt="Hugo Future Imperfect Slim"></a><header><h1>Wayne Huang</h1></header><main><p>Stay Curious and Embrace simplicity in life.</p></main><footer><ul class=socnet-icons><li><a href=//github.com/waynehuangplus target=_blank rel=noopener title=GitHub class="fab fa-github"></a></li><li><a href=//www.linkedin.com/in/waynehuangplus target=_blank rel=noopener title=LinkedIn class="fab fa-linkedin"></a></li><li><a href=//facebook.com/wayne.huang.148 target=_blank rel=noopener title=Facebook class="fab fa-facebook"></a></li><li><a href=mailto:blog_contact@tomail.cc target=_blank title=Email class="far fa-envelope"></a></li></ul></footer></section><main id=site-main><article><div class=post><header><div class=title><h2><a href=/blog/2021/06/auto-scaling-process-is-slow-on-amazon-eks-with-nlb/>Auto-scaling process is slow on Amazon EKS with NLB</a></h2><p>Register target with target group is slow than expected behind the Network Load Balancer</p></div><div class=meta><time datetime="2021-06-07 01:31:19 +0000 UTC">June 7, 2021</time><p>3-Minute Read</p></div></header><div id=socnet-share><a href="//twitter.com/share?text=Auto-scaling%20process%20is%20slow%20on%20Amazon%20EKS%20with%20NLB&url=https%3a%2f%2fblog.wayne.wiki%2fblog%2f2021%2f06%2fauto-scaling-process-is-slow-on-amazon-eks-with-nlb%2f" target=_blank rel=noopener class="nav share-btn twitter"><p>Twitter</p></a><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.wayne.wiki%2fblog%2f2021%2f06%2fauto-scaling-process-is-slow-on-amazon-eks-with-nlb%2f" target=_blank rel=noopener class="nav share-btn facebook"><p>Facebook</p></a><a href="//www.reddit.com/submit?url=https%3a%2f%2fblog.wayne.wiki%2fblog%2f2021%2f06%2fauto-scaling-process-is-slow-on-amazon-eks-with-nlb%2f&title=Auto-scaling%20process%20is%20slow%20on%20Amazon%20EKS%20with%20NLB" target=_blank rel=noopener class="nav share-btn reddit"><p>Reddit</p></a><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fblog.wayne.wiki%2fblog%2f2021%2f06%2fauto-scaling-process-is-slow-on-amazon-eks-with-nlb%2f&title=Auto-scaling%20process%20is%20slow%20on%20Amazon%20EKS%20with%20NLB" target=_blank rel=noopener class="nav share-btn linkedin"><p>LinkedIn</p></a><a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fblog.wayne.wiki%2fblog%2f2021%2f06%2fauto-scaling-process-is-slow-on-amazon-eks-with-nlb%2f&description=Auto-scaling%20process%20is%20slow%20on%20Amazon%20EKS%20with%20NLB" target=_blank rel=noopener class="nav share-btn pinterest"><p>Pinterest</p></a><a href="mailto:?subject=Check%20out%20this%20post%20by %7b%20%20%20%20%20%20%20%20map%5b%5d%7d&body=https%3a%2f%2fblog.wayne.wiki%2fblog%2f2021%2f06%2fauto-scaling-process-is-slow-on-amazon-eks-with-nlb%2f" target=_blank class="nav share-btn email" data-proofer-ignore><p>Email</p></a></div><div class=content><a href=/blog/2021/06/auto-scaling-process-is-slow-on-amazon-eks-with-nlb/ class=image style="--bg-image:url('https://blog.wayne.wiki/img/post/2021-06-07-joshua-hoehne-7uN0bC2sNYE-unsplash.jpg')"><img class=stretchV src=https://blog.wayne.wiki/img/post/2021-06-07-joshua-hoehne-7uN0bC2sNYE-unsplash.jpg alt=slow-by-joshua-hoehne></a><h1 id=background>Background</h1><p>One of my customers wants to build the workloads on <strong>Amazon EKS</strong>, and plan to leverage <strong>Pod AutoScaler</strong> to automatically scale the number of pods in a deployment. The LoadBalancer type ahead the target group is <strong>NLB (Network Load Balancer)</strong> in their use case.</p><figure><img src=https://d2908q01vomqb2.cloudfront.net/fe2ef495a1152561572949784c16bf23abb28057/2021/03/19/Ingress1.png alt=https://aws.amazon.com/blogs/containers/setting-up-end-to-end-tls-encryption-on-amazon-eks-with-the-new-aws-load-balancer-controller/><figcaption><h4>Ingress traffic to Amazon EKS</h4></figcaption></figure><p>Customer expects the registration flow of new target should be soon (less than one minute), but the real situation is that it takes minutes before the new provisioned Pod can start to serve traffic.</p><p>My gut feeling says it should not be so slow for a new Pod to become healthy status. At first, I have suspected it&rsquo;s due to the <strong>health check interval</strong> is too high, so I checked with customer and they have already adjusted to the minimum interval, 10 seconds.</p><p>Later I asked customer to open a support case to the support engineer team who can help to dig into the detail of AWS back-end service to know why the provisioned time is longer than expected.</p><p>The interesting thing is I suggested them to use <strong>ALB (Application Load Balancer)</strong>, and don&rsquo;t know why they switch to NLB on the architecture. Finally, I know the reason and they back to use ALB again, but it&rsquo;s another story we can talk later.</p><hr><h1 id=why->Why ?</h1><p>As discussed with our support engineer, I realized it&rsquo;s a known and current a limitation to NLB. But why does the process take so long time ? We can divide the the whole process into few steps,</p><ol><li>When a <strong>new target</strong> is registered to a Network Load Balancer, it would be stayed on <strong><em>initial state</em></strong> before complete and may be up to 180 seconds to finish.</li><li>After registration is complete and the state become <strong><em>unhealthy</em></strong>, the Network Load Balancer health check systems start to send health checks to the target.</li><li>Until the real health check data is gathered (depends on your health check interval and the threshold), your target will become <strong><em>healthy</em></strong> state and can start to service traffic.</li></ol><p>We can know the AWS health check systems don&rsquo;t check your target at the beginning of registration, and the health checks will be started until the <strong><em>initial state</em></strong> is complete.</p><p>For example, if I configured the health check for a <strong>30 seconds interval</strong> and required a <strong>healthy threshold of 3</strong> to decide whether a target is healthy. It would take <strong>3 * 30 = 90 seconds</strong> in the health check process. The worst case for a newly registered target could enter service taking <strong>270 seconds (90 + 180 seconds)</strong>. That means it would be over 4 minutes sometimes.</p><p>Similarly, it also happens on the de-registration process from NLB, so you need to take this into consideration.</p><hr><h1 id=conclusion>Conclusion</h1><p>To my customer, it&rsquo;s still better for them to use ALB under the scenario, so they finally switch back to ALB and ALB doesn&rsquo;t have this kind of limitation. Based on the experiment between me and our support engineer, the process on ALB is <strong>less than 20 seconds</strong>, so I think it would be an expected case to me.</p><p>If you have to use NLB and want to avoid slow provision time on your EKS cluster, you can consider to scale your environment in advance and consider the provision time into your auto-scaling strategy.</p><hr><h1 id=reference>Reference</h1><ul><li>stackoverflow - <a href=https://stackoverflow.com/questions/47256085/aws-network-elb-take-4-minutes-to-recognise-target-as-healthy>AWS Network ELB take 4 minutes to recognise target as healthy</a></li><li>Reddit - <a href=https://www.reddit.com/r/aws/comments/d19054/nlb_slow_to_react_to_target_group_changes/>NLB slow to react to target group changes?</a></li></ul></div><footer><div class=stats><ul class=categories><li><a class=article-terms-link href=/categories/aws/>AWS</a></li></ul><ul class=tags><li><a class=article-terms-link href=/tags/aws/>AWS</a></li><li><a class=article-terms-link href=/tags/nlb/>NLB</a></li><li><a class=article-terms-link href=/tags/eks/>EKS</a></li><li><a class=article-terms-link href=/tags/auto-scaling/>auto-scaling</a></li><li><a class=article-terms-link href=/tags/health-check/>health-check</a></li></ul></div></footer></div></article><div class=pagination><a href=/blog/2021/06/amazon-connect-intro-and-challenges-in-taiwan/ class="button left"><span>聊聊 Amazon Connect 與可能的應用</span></a>
<a href=/blog/2021/06/japan-style-fried-steak/ class="button right"><span>炸牛排初體驗</span></a></div></main><section id=site-sidebar><section id=recent-posts><header><h1>Recent Posts</h1></header><article class=mini-post><a href=/blog/2021/06/amazon-connect-intro-and-challenges-in-taiwan/ class=image style="--bg-image:url('https://blog.wayne.wiki/img/post/2021-06-09-screen-shot-2021-06-09-at-9-05-45-pm.png')"><img class=stretchV src=https://blog.wayne.wiki/img/post/2021-06-09-screen-shot-2021-06-09-at-9-05-45-pm.png alt="Connect Logo"></a><header><h2><a href=/blog/2021/06/amazon-connect-intro-and-challenges-in-taiwan/>聊聊 Amazon Connect 與可能的應用</a></h2><time class=published datetime="2021-06-07 03:16:34 +0000 UTC">June 7, 2021</time></header></article><article class=mini-post><a href=/blog/2021/06/auto-scaling-process-is-slow-on-amazon-eks-with-nlb/ class=image style="--bg-image:url('https://blog.wayne.wiki/img/post/2021-06-07-joshua-hoehne-7uN0bC2sNYE-unsplash.jpg')"><img class=stretchV src=https://blog.wayne.wiki/img/post/2021-06-07-joshua-hoehne-7uN0bC2sNYE-unsplash.jpg alt=slow-by-joshua-hoehne></a><header><h2><a href=/blog/2021/06/auto-scaling-process-is-slow-on-amazon-eks-with-nlb/>Auto-scaling process is slow on Amazon EKS with NLB</a></h2><time class=published datetime="2021-06-07 01:31:19 +0000 UTC">June 7, 2021</time></header></article><article class=mini-post><a href=/blog/2021/06/japan-style-fried-steak/ class=image style="--bg-image:url('https://blog.wayne.wiki/img/post/2021-06-06-191585595_10158960081761727_2696007663873086144_n.jpg')"><img class=stretchV src=https://blog.wayne.wiki/img/post/2021-06-06-191585595_10158960081761727_2696007663873086144_n.jpg alt></a><header><h2><a href=/blog/2021/06/japan-style-fried-steak/>炸牛排初體驗</a></h2><time class=published datetime="2021-06-06 14:00:00 +0000 UTC">June 6, 2021</time></header></article><article class=mini-post><a href=/blog/2021/06/home-made-umeshu/ class=image style="--bg-image:url('https://blog.wayne.wiki/img/post/2021-06-06-18d31dbb-7159-42ce-a4a0-a2d651775e33_1_105_c.jpeg')"><img class=stretchV src=https://blog.wayne.wiki/img/post/2021-06-06-18d31dbb-7159-42ce-a4a0-a2d651775e33_1_105_c.jpeg alt></a><header><h2><a href=/blog/2021/06/home-made-umeshu/>淺漬梅酒</a></h2><time class=published datetime="2021-06-06 09:25:30 +0000 UTC">June 6, 2021</time></header></article><article class=mini-post><header><h2><a href=/blog/2021/06/my-first-post/>My First Post</a></h2><time class=published datetime="2021-06-05 12:23:20 +0800 +0800">June 5, 2021</time></header></article><footer><a href=/blog class=button>See More</a></footer></section><section id=categories><header><h1><a href=/categories>Categories</a></h1></header><ul><li><a href=/categories/aws/>aws<span class=count>2</span></a><li><a href=/categories/cooking/>cooking<span class=count>2</span></a><li><a href=/categories/home-made/>home-made<span class=count>2</span></a></li></ul></section><section id=mini-bio><header><h1>About</h1></header><p>Wayne has 7+ years experience in Software Development, and now is a Solutions Architect.<br><br>Wayne like to take challenges and keep to learn new things. In daily life, he enjoys to do cooking and baking, and also a motorcyclist.</p><footer><a href=/about class=button>Learn More</a></footer></section></section><footer id=site-footer><ul class=socnet-icons><li><a href=//github.com/waynehuangplus target=_blank rel=noopener title=GitHub class="fab fa-github"></a></li><li><a href=//www.linkedin.com/in/waynehuangplus target=_blank rel=noopener title=LinkedIn class="fab fa-linkedin"></a></li><li><a href=//facebook.com/wayne.huang.148 target=_blank rel=noopener title=Facebook class="fab fa-facebook"></a></li><li><a href=mailto:blog_contact@tomail.cc target=_blank title=Email class="far fa-envelope"></a></li></ul><p class=copyright>© 2021 The Jorney of Wayne<br>Theme: <a href=https://github.com/pacollins/hugo-future-imperfect-slim target=_blank rel=noopener>Hugo Future Imperfect Slim</a><br>A <a href=https://html5up.net/future-imperfect target=_blank rel=noopener>HTML5 UP port</a> | Powered by <a href=https://gohugo.io/ title=0.83.1 target=_blank rel=noopener>Hugo</a></p></footer><a id=back-to-top href=# class="fas fa-arrow-up fa-2x"></a><script src=/js/highlight.js></script><script>hljs.highlightAll()</script><script src=/js/bundle.min.40f5d677480c5c4ce53cf126a9dd3064358bb3240c0dfa20dc81e13ace7d4f57.js integrity="sha256-QPXWd0gMXEzlPPEmqd0wZDWLsyQMDfog3IHhOs59T1c="></script><script src=/js/add-on.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-5GJDNQ79QD"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-5GJDNQ79QD',{anonymize_ip:!1})}</script></div></body></html>